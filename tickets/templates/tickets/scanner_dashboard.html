{% extends "tickets/base.html" %}
{% load static %}

{% block head %}
  <!-- html5-qrcode CDN -->
  <script src="https://unpkg.com/html5-qrcode@2.3.7/minified/html5-qrcode.min.js"></script>
{% endblock %}

{% block title %}QR Scanner - Bilet Kontrol{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <h2 class="mb-4">Bilet QR Scanner</h2>
        </div>
    </div>
    
    <div class="row">
        <!-- QR Scanner -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">QR Kodu Okutun</h5>
                </div>
                <div class="card-body">
                    <div id="reader" width="100%"></div>
                    <div class="text-center mt-3">
                        <button id="startScanner" class="btn btn-primary">Scanner'ı Başlat</button>
                        <button id="stopScanner" class="btn btn-secondary" disabled>Scanner'ı Durdur</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Bilet Bilgileri -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Bilet Bilgileri</h5>
                </div>
                <div class="card-body">
                    <div id="ticketInfo">
                        <p class="text-muted">QR kodu okutunca bilet bilgileri burada görünecek.</p>
                    </div>
                    <div id="ticketActions" class="mt-3" style="display: none;">
                        <button id="useTicket" class="btn btn-success">Giriş Yaptır</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/html5-qrcode"></script>
<script>
let html5QrcodeScanner;
let currentTicketId = null;

document.getElementById('startScanner').addEventListener('click', function() {
    this.disabled = true;
    document.getElementById('stopScanner').disabled = false;
    
    html5QrcodeScanner = new Html5QrcodeScanner(
        "reader", { fps: 10, qrbox: 250 });
    
    html5QrcodeScanner.render(onScanSuccess);
});

document.getElementById('stopScanner').addEventListener('click', function() {
    if (html5QrcodeScanner) {
        html5QrcodeScanner.clear().then(() => {
            document.getElementById('startScanner').disabled = false;
            this.disabled = true;
        });
    }
});

function onScanSuccess(decodedText, decodedResult) {
    // QR kodundan ticket UUID'sini al
    const ticketUuid = decodedText;
    checkTicket(ticketUuid);
    
    // Scanner'ı durdur
    if (html5QrcodeScanner) {
        html5QrcodeScanner.clear();
        document.getElementById('startScanner').disabled = false;
        document.getElementById('stopScanner').disabled = true;
    }
}

function checkTicket(ticketUuid) {
    fetch(`/api/check_ticket/${ticketUuid}/`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayTicketInfo(data.ticket);
                currentTicketId = ticketUuid;
            } else {
                showError(data.error);
            }
        })
        .catch(error => {
            showError('Bir hata oluştu: ' + error);
        });
}

function displayTicketInfo(ticket) {
    const ticketInfo = document.getElementById('ticketInfo');
    const ticketActions = document.getElementById('ticketActions');
    
    let statusBadge = ticket.status === 'used' ? 
        '<span class="badge bg-danger">Kullanılmış</span>' : 
        '<span class="badge bg-success">Aktif</span>';
    
    ticketInfo.innerHTML = `
        <h5>${ticket.event_name}</h5>
        <p><strong>Katılımcı:</strong> ${ticket.attendee_name}</p>
        <p><strong>+1 Sayısı:</strong> ${ticket.plus_ones}</p>
        <p><strong>Etkinlik Tarihi:</strong> ${ticket.event_date}</p>
        <p><strong>Mekan:</strong> ${ticket.event_location}</p>
        <p><strong>Durum:</strong> ${statusBadge}</p>
    `;
    
    if (ticket.status === 'unused') {
        ticketActions.style.display = 'block';
    } else {
        ticketActions.style.display = 'none';
    }
}

document.getElementById('useTicket').addEventListener('click', function() {
    if (!currentTicketId) return;
    
    fetch(`/api/use_ticket/${currentTicketId}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/json',
        },
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Bilet başarıyla kullanıldı!');
            checkTicket(currentTicketId); // Bilgileri güncelle
        } else {
            alert('Hata: ' + data.error);
        }
    })
    .catch(error => {
        alert('Bir hata oluştu: ' + error);
    });
});

function showError(message) {
    const ticketInfo = document.getElementById('ticketInfo');
    ticketInfo.innerHTML = `
        <div class="alert alert-danger">
            <strong>Hata!</strong> ${message}
        </div>
    `;
    document.getElementById('ticketActions').style.display = 'none';
}
</script>
{% endblock %}