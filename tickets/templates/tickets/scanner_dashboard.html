{% extends "tickets/base.html" %}
{% load static %}
{% block extra_js %}
<script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
{% endblock %}
{% block title %}QR Scanner - Bilet Kontrol{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <h2 class="mb-4">Bilet QR Scanner</h2>
        </div>
    </div>
    
    <div class="row">
        <!-- QR Scanner -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">QR Kodu Okutun</h5>
                </div>
                <div class="card-body">
                    <div id="reader" width="100%"></div>
                </div>
            </div>
        </div>
        
        <!-- Bilet Bilgileri -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Bilet Bilgileri</h5>
                </div>
                <div class="card-body">
                    <div id="ticketInfo">
                        <p class="text-muted">QR kodu okutunca bilet bilgileri burada görünecek.</p>
                    </div>
                    <div id="ticketActions" class="mt-3" style="display: none;">
                        <button id="useTicket" class="btn btn-success">Check In</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Son Kontroller -->
        <div class="card mt-4">
            <div class="card-header">
                <h6 class="mb-0">Son Kontroller</h6>
            </div>
            <div class="card-body">
                <div id="recentScans"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js_2 %}
    
<script>
// Global variables

let html5QrcodeScanner = null;
let currentTicketId = null;
let lastScannedAt = 0; // ms, debounce
// DOM Elements
const ticketInfoDiv = document.getElementById('ticketInfo');
const ticketActionsDiv = document.getElementById('ticketActions');
const useTicketBtn = document.getElementById('useTicket');
const recentScansDiv = document.getElementById('recentScans');
const readerEl = document.getElementById('reader');

// small safety if elements are missing
if (!readerEl) console.warn('reader element not found: #reader');

function flashReader(kind, message) {
    // kind: 'detect' | 'success' | 'error'
    if (!readerEl) return;
    // ensure reader is positioned for overlay
    readerEl.classList.add('reader-ready');

    // add class for color effect
    readerEl.classList.remove('flash-detect','flash-success','flash-error');
    readerEl.offsetWidth; // force reflow to restart animation
    readerEl.classList.add(kind === 'success' ? 'flash-success' : (kind === 'error' ? 'flash-error' : 'flash-detect'));

    // overlay text
    let overlay = readerEl.querySelector('.scan-overlay');
    if (!overlay) {
        overlay = document.createElement('div');
        overlay.className = 'scan-overlay';
        readerEl.appendChild(overlay);
    }
    overlay.textContent = message || (kind === 'success' ? 'OK' : (kind === 'error' ? 'HATA' : 'TARANDI'));
    overlay.classList.remove('show');
    // small timeout to ensure CSS transition
    setTimeout(() => overlay.classList.add('show'), 10);

    // remove effect after short delay
    setTimeout(() => {
        overlay.classList.remove('show');
        readerEl.classList.remove('flash-detect','flash-success','flash-error');
    }, 1000);
}

// Check Ticket Function
function checkTicket(ticketUuid) {
    // Loading state
    flashReader('detect','TARANDI');

    ticketInfoDiv.innerHTML = `
        <div class="text-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Yükleniyor...</span>
            </div>
            <p class="mt-2">Bilet kontrol ediliyor...</p>
        </div>
    `;
    ticketActionsDiv.style.display = 'none';
    
    // API call
    fetch(`/api/check_ticket/${ticketUuid}/`)
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                displayTicketInfo(data.ticket);
                currentTicketId = ticketUuid;
                addToRecentScans(data.ticket);
                flashReader('success','OK');
            } else {
                showError(data.error || 'Bilet bulunamadı');
                flashReader('error','HATA');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showError('Bir hata oluştu: ' + error.message);
            flashReader('error','HATA');
        });
}

// Display Ticket Info
function displayTicketInfo(ticket) {
    const statusBadge = ticket.status === 'used' ? 
        '<span class="badge bg-danger">Girdi</span>' : 
        '<span class="badge bg-success">Girmedi</span>';
    
    const isUsed = ticket.status === 'used';
    
    ticketInfoDiv.innerHTML = `
        <div class="ticket-details">
            <h4 class="text-primary">${ticket.event_name}</h4>
            <hr>
            <div class="row">
                <div class="col-6">
                    <strong>Katılımcı:</strong>
                </div>
                <div class="col-6">
                    ${ticket.attendee_name}
                </div>
            </div>
            <div class="row">
                <div class="col-6">
                    <strong>+1 Sayısı:</strong>
                </div>
                <div class="col-6">
                    ${ticket.plus_ones}
                </div>
            </div>
            <div class="row">
                <div class="col-6">
                    <strong>Etkinlik:</strong>
                </div>
                <div class="col-6">
                    ${ticket.event_date}
                </div>
            </div>
            <div class="row">
                <div class="col-6">
                    <strong>Mekan:</strong>
                </div>
                <div class="col-6">
                    ${ticket.event_location}
                </div>
            </div>
            <div class="row mt-2">
                <div class="col-12">
                    <strong>Durum:</strong> ${statusBadge}
                </div>
            </div>
        </div>
    `;
    
    if (!isUsed) {
        ticketActionsDiv.style.display = 'block';
    } else {
        ticketActionsDiv.style.display = 'none';
    }
}

// Use Ticket
useTicketBtn.addEventListener('click', function() {
    if (!currentTicketId) return;
    
    useTicketBtn.disabled = true;
    useTicketBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> İşleniyor...';
    
    fetch(`/api/use_ticket/${currentTicketId}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json',
        },
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showSuccess('Bilet başarıyla kullanıldı!');
            // Bilgileri güncelle
            checkTicket(currentTicketId);
        } else {
            showError('Hata: ' + data.error);
        }
    })
    .catch(error => {
        showError('Bir hata oluştu: ' + error);
    })
    .finally(() => {
        useTicketBtn.disabled = false;
        useTicketBtn.innerHTML = '<i class="fas fa-check-circle"></i> Giriş Yaptır';
    });
});

// Recent Scans
function addToRecentScans(ticket) {
    const scanItem = document.createElement('div');
    scanItem.className = 'scan-item mb-2 p-2 border rounded';
    scanItem.innerHTML = `
        <div class="d-flex justify-content-between">
            <strong>${ticket.attendee_name}</strong>
            <span class="badge ${ticket.status === 'used' ? 'bg-danger' : 'bg-success'}">
                ${ticket.status === 'used' ? 'Girdi' : 'Girmedi'}
            </span>
        </div>
        <small class="text-muted">${new Date().toLocaleTimeString()}</small>
    `;
    
    recentScansDiv.insertBefore(scanItem, recentScansDiv.firstChild);
    
    // En fazla 5 kayıt tut
    if (recentScansDiv.children.length > 5) {
        recentScansDiv.removeChild(recentScansDiv.lastChild);
    }
}

// Utility Functions
function showError(message) {
    ticketInfoDiv.innerHTML = `
        <div class="alert alert-danger">
            <h5><i class="fas fa-exclamation-triangle"></i> Hata!</h5>
            ${message}
        </div>
    `;
    ticketActionsDiv.style.display = 'none';
}

function showSuccess(message) {
    const alertDiv = document.createElement('div');
    alertDiv.className = 'alert alert-success alert-dismissible fade show';
    alertDiv.innerHTML = `
        <strong>Başarılı!</strong> ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.querySelector('main').insertBefore(alertDiv, document.querySelector('main').firstChild);
    
    // Auto remove after 3 seconds
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 3000);
}

// CSRF Token helper
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    console.log('QR Scanner initialized');
    function onScanSuccess(decodedText, decodedResult) {
        const now = Date.now();
        if (now - lastScannedAt < 1500) return; // 1.5s debounce
        lastScannedAt = now;
        const ticketUuid = decodedText.trim();
        console.log('Scan success', ticketUuid);
        checkTicket(ticketUuid);
        // don't stop scanner — allow continuous scanning
    }

    function onScanFailure(error) {
        // ignore
    }

    try {
        // use low-level Html5Qrcode to avoid built-in UI (no "Stop scanning" text)
        const readerId = "reader";
        const config = { fps: 10, qrbox: { width: 250, height: 250 } };
        html5QrcodeScanner = new Html5Qrcode(readerId);
        Html5Qrcode.getCameras().then(cameras => {
            if (!cameras || cameras.length === 0) {
                throw new Error('Cihazda kamera bulunamadı');
            }
            // prefer environment-facing camera if available
            const cameraId = cameras[0].id || { facingMode: "environment" };
            return html5QrcodeScanner.start(
                cameraId,
                config,
                onScanSuccess,
                onScanFailure
            );
        }).then(() => {
            console.log('camera started (no UI buttons shown)');
        }).catch(err => {
            console.error('Scanner start error', err);
            showError('Kamera başlatılamadı: ' + (err.message || err));
        });
     } catch (e) {
         console.error('Scanner start error', e);
         showError('Kamera başlatılamadı: ' + (e.message || e));
     }
});
</script>

<style>
#reader {
    border: 2px dashed #dee2e6;
    border-radius: 8px;
    min-height: 300px;
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative; /* needed for overlay */
    transition: box-shadow 180ms ease, border-color 180ms ease;
}

/* visual flash states */
#reader.flash-detect {
    box-shadow: 0 0 18px rgba(255, 193, 7, 0.9);
    border-color: #ffc107;
}
#reader.flash-success {
    box-shadow: 0 0 26px rgba(25, 135, 84, 0.95);
    border-color: #198754;
}
#reader.flash-error {
    box-shadow: 0 0 26px rgba(220, 53, 69, 0.95);
    border-color: #dc3545;
}

/* overlay text that fades in/out */
.scan-overlay {
    position: absolute;
    top: 12px;
    right: 12px;
    padding: 6px 10px;
    border-radius: 6px;
    background: rgba(0,0,0,0.7);
    color: #fff;
    font-weight: 600;
    font-size: 0.95rem;
    opacity: 0;
    transform: translateY(-6px);
    transition: opacity 220ms ease, transform 220ms ease;
    pointer-events: none;
    z-index: 50;
}
.scan-overlay.show {
    opacity: 1;
    transform: translateY(0);
}

/* optional: slightly different color for overlay text on success/error */
#reader.flash-success .scan-overlay { background: rgba(25,135,84,0.95); }
#reader.flash-error .scan-overlay { background: rgba(220,53,69,0.95); }
#reader.flash-detect .scan-overlay { background: rgba(255,193,7,0.95); }

/* keep other styles */
.scan-item {
    background-color: #f8f9fa;
}

.ticket-details {
    font-size: 0.95rem;
}

.btn {
    transition: all 0.3s ease;
}

.btn:hover {
    transform: translateY(-2px);
}
</style>
{% endblock %}